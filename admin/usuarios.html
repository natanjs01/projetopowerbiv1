<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rios - BI Portal Secure</title>
    
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üîê BI Portal</h2>
                <p>Administra√ß√£o</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="index.html" class="menu-item">
                    <span class="menu-item-icon">üìä</span>
                    Dashboard
                </a>
                <a href="usuarios.html" class="menu-item active">
                    <span class="menu-item-icon">üë•</span>
                    Usu√°rios
                </a>
                <a href="relatorios.html" class="menu-item">
                    <span class="menu-item-icon">üìÅ</span>
                    Relat√≥rios
                </a>
                <a href="setores.html" class="menu-item">
                    <span class="menu-item-icon">üè¢</span>
                    Setores
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <span class="usuario-inicial"></span>
                    </div>
                    <div class="user-details">
                        <div class="user-name usuario-nome"></div>
                        <div class="user-role">Administrador</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-block btn-sm btn-logout">
                    Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1 class="content-title">Gerenciar Usu√°rios</h1>
                <button class="btn btn-primary" onclick="abrirModalUsuario()">
                    + Novo Usu√°rio
                </button>
            </div>

            <!-- Filtros -->
            <div class="card">
                <div class="card-body">
                    <div class="filtros">
                        <input type="text" id="filtroNome" placeholder="üîç Buscar por nome ou e-mail..." class="input">
                        <select id="filtroSetor" class="input">
                            <option value="">üìÅ Todos os setores</option>
                        </select>
                        <select id="filtroStatus" class="input">
                            <option value="">üîò Todos os status</option>
                            <option value="true">‚úÖ Ativos</option>
                            <option value="false">‚ùå Inativos</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabela de Usu√°rios -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="usuariosTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Setor</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Usu√°rio -->
    <div class="modal" id="modalUsuario">
        <div class="modal-content modal-md">
            <div class="modal-header">
                <div>
                    <h3 id="modalUsuarioTitulo">üë§ Novo Usu√°rio</h3>
                    <p class="modal-subtitle">Preencha os dados do novo usu√°rio</p>
                </div>
                <button class="modal-close" onclick="fecharModalUsuario()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formUsuario" onsubmit="salvarUsuario(event)">
                    <input type="hidden" id="usuarioId" value="">
                    
                    <!-- Informa√ß√µes Pessoais -->
                    <div class="form-section">
                        <h4 class="form-section-title">üìã Informa√ß√µes Pessoais</h4>
                        
                        <div class="form-group">
                            <label for="usuarioNome" class="form-label">
                                <span class="label-text">Nome Completo</span>
                                <span class="label-required">*</span>
                            </label>
                            <input type="text" 
                                   id="usuarioNome" 
                                   class="input" 
                                   placeholder="Digite o nome completo do usu√°rio"
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="usuarioEmail" class="form-label">
                                <span class="label-text">E-mail</span>
                                <span class="label-required">*</span>
                            </label>
                            <input type="email" 
                                   id="usuarioEmail" 
                                   class="input" 
                                   placeholder="usuario@empresa.com"
                                   required>
                            <small class="form-help">O e-mail ser√° usado para login no sistema</small>
                        </div>
                    </div>

                    <!-- Configura√ß√µes de Acesso -->
                    <div class="form-section">
                        <h4 class="form-section-title">‚öôÔ∏è Configura√ß√µes de Acesso</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="usuarioSetor" class="form-label">
                                    <span class="label-text">Setor</span>
                                    <span class="label-required">*</span>
                                </label>
                                <select id="usuarioSetor" class="input" required>
                                    <option value="">Selecione o setor...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="usuarioTipo" class="form-label">
                                    <span class="label-text">Tipo de Usu√°rio</span>
                                    <span class="label-required">*</span>
                                </label>
                                <select id="usuarioTipo" class="input" required>
                                    <option value="comum">Comum</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="usuarioAtivo" checked>
                                <span class="checkbox-text">
                                    <strong>Usu√°rio Ativo</strong>
                                    <small>Desmarque para desativar o acesso ao sistema</small>
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="fecharModalUsuario()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span id="btnSalvarTexto">üíæ Salvar Usu√°rio</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Resetar Senha -->
    <div class="modal" id="modalResetSenha">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>Resetar Senha</h3>
                <button class="modal-close" onclick="fecharModalReset()">&times;</button>
            </div>
            <div class="modal-body">
                <p>A senha tempor√°ria ser√° gerada automaticamente e o usu√°rio ser√° obrigado a troc√°-la no pr√≥ximo acesso.</p>
                
                <div class="alert alert-warning">
                    <strong>Aten√ß√£o:</strong> Copie a senha gerada e envie ao usu√°rio de forma segura.
                </div>

                <div id="senhaGeradaContainer" style="display:none;">
                    <div class="form-group">
                        <label>Senha Tempor√°ria Gerada:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="senhaGerada" class="input" readonly>
                            <button type="button" class="btn btn-secondary" onclick="copiarSenha()">
                                üìã Copiar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalReset()">
                        Fechar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnResetarSenha" onclick="confirmarReset()">
                        Gerar Nova Senha
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Senha Tempor√°ria -->
    <div class="modal" id="modalSenhaTemporaria">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3>‚úÖ Usu√°rio Criado com Sucesso!</h3>
                <button class="modal-close" onclick="fecharModalSenhaTemporaria()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <strong>Usu√°rio criado com sucesso!</strong>
                </div>
                
                <p>Copie a senha tempor√°ria abaixo e envie ao usu√°rio de forma segura:</p>
                
                <div class="form-group">
                    <label><strong>Senha Tempor√°ria:</strong></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="senhaTemporariaGerada" class="input" readonly style="font-family: monospace; font-size: 16px; font-weight: bold; color: #2563eb;">
                        <button type="button" class="btn btn-primary" onclick="copiarSenhaTemporaria()">
                            üìã Copiar
                        </button>
                    </div>
                </div>

                <div class="alert alert-warning" style="margin-top: 16px;">
                    <strong>‚ö†Ô∏è Importante:</strong> O usu√°rio ser√° obrigado a trocar esta senha no primeiro acesso.
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="fecharModalSenhaTemporaria()">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/reports.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/main.js"></script>
    
    <script>
        let usuarioResetId = null;
        let setoresDisponiveis = [];

        // Proteger p√°gina (apenas admin)
        if (!protegerPagina('admin')) {
            // J√° redirecionou
        }

        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = obterSessao();
            if (usuario) {
                const inicial = usuario.nome.charAt(0).toUpperCase();
                document.querySelectorAll('.usuario-inicial').forEach(el => el.textContent = inicial);
            }

            await carregarSetores();
            await carregarUsuarios();
            
            // Configurar filtros autom√°ticos
            document.getElementById('filtroNome').addEventListener('input', carregarUsuarios);
            document.getElementById('filtroSetor').addEventListener('change', carregarUsuarios);
            document.getElementById('filtroStatus').addEventListener('change', carregarUsuarios);
        });

        // Carregar setores
        async function carregarSetores() {
            try {
                const { data, error } = await supabase
                    .from('setores')
                    .select('*')
                    .order('nome');

                if (error) throw error;

                setoresDisponiveis = data;

                // Preencher selects com nome do setor como valor
                const optionsHTML = data.map(setor => 
                    `<option value="${setor.nome}">${setor.nome}</option>`
                ).join('');

                document.getElementById('filtroSetor').innerHTML = 
                    '<option value="">üìÅ Todos os setores</option>' + optionsHTML;
                
                document.getElementById('usuarioSetor').innerHTML = 
                    '<option value="">Selecione...</option>' + optionsHTML;
            } catch (error) {
                console.error('Erro ao carregar setores:', error);
            }
        }

        // Carregar usu√°rios
        async function carregarUsuarios() {
            const tbody = document.getElementById('usuariosTableBody');
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroSetor = document.getElementById('filtroSetor').value;
            const filtroStatus = document.getElementById('filtroStatus').value;

            try {
                let query = supabase
                    .from('usuarios')
                    .select('*');

                if (filtroSetor) {
                    query = query.eq('setor', filtroSetor);
                }

                if (filtroStatus !== '') {
                    query = query.eq('ativo', filtroStatus === 'true');
                }

                const { data, error } = await query.order('nome');

                if (error) throw error;

                // Filtro de nome/email no client-side
                let usuarios = data;
                if (filtroNome) {
                    usuarios = data.filter(u => 
                        u.nome.toLowerCase().includes(filtroNome) ||
                        u.email.toLowerCase().includes(filtroNome)
                    );
                }

                if (usuarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum usu√°rio encontrado</td></tr>';
                    return;
                }

                tbody.innerHTML = usuarios.map(usuario => `
                    <tr>
                        <td>${usuario.nome}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.setor || '-'}</td>
                        <td>
                            <span class="badge ${usuario.tipo_usuario === 'admin' ? 'badge-danger' : 'badge-info'}">
                                ${usuario.tipo_usuario === 'admin' ? 'Admin' : 'Comum'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${usuario.ativo ? 'badge-success' : 'badge-secondary'}">
                                ${usuario.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editarUsuario('${usuario.id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="abrirModalReset('${usuario.id}')" title="Resetar Senha">
                                üîë
                            </button>
                            <button class="btn btn-sm ${usuario.ativo ? 'btn-danger' : 'btn-success'}" 
                                    onclick="toggleAtivo('${usuario.id}', ${!usuario.ativo})" 
                                    title="${usuario.ativo ? 'Desativar' : 'Ativar'}">
                                ${usuario.ativo ? 'üö´' : '‚úÖ'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Erro ao carregar usu√°rios</td></tr>';
            }
        }

        // Abrir modal para novo usu√°rio
        function abrirModalUsuario() {
            document.getElementById('modalUsuarioTitulo').innerHTML = 'üë§ Novo Usu√°rio';
            document.querySelector('.modal-subtitle').textContent = 'Preencha os dados do novo usu√°rio';
            document.getElementById('btnSalvarTexto').innerHTML = 'üíæ Salvar Usu√°rio';
            document.getElementById('formUsuario').reset();
            document.getElementById('usuarioId').value = '';
            document.getElementById('usuarioAtivo').checked = true;
            document.getElementById('modalUsuario').style.display = 'flex';
        }

        // Fechar modal usu√°rio
        function fecharModalUsuario() {
            document.getElementById('modalUsuario').style.display = 'none';
        }

        // Editar usu√°rio
        async function editarUsuario(id) {
            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                document.getElementById('modalUsuarioTitulo').innerHTML = '‚úèÔ∏è Editar Usu√°rio';
                document.querySelector('.modal-subtitle').textContent = 'Atualize os dados do usu√°rio';
                document.getElementById('btnSalvarTexto').innerHTML = 'üíæ Atualizar Usu√°rio';
                document.getElementById('usuarioId').value = data.id;
                document.getElementById('usuarioNome').value = data.nome;
                document.getElementById('usuarioEmail').value = data.email;
                document.getElementById('usuarioSetor').value = data.setor || '';
                document.getElementById('usuarioTipo').value = data.tipo_usuario;
                document.getElementById('usuarioAtivo').checked = data.ativo;
                
                document.getElementById('modalUsuario').style.display = 'flex';
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                mostrarAlerta('Erro ao carregar dados do usu√°rio', 'error');
            }
        }

        // Salvar usu√°rio
        async function salvarUsuario(event) {
            event.preventDefault();

            const id = document.getElementById('usuarioId').value;
            const nome = document.getElementById('usuarioNome').value;
            const email = document.getElementById('usuarioEmail').value;
            const setor = document.getElementById('usuarioSetor').value || null;
            const tipo = document.getElementById('usuarioTipo').value;
            const ativo = document.getElementById('usuarioAtivo').checked;

            try {
                if (id) {
                    // Atualizar usu√°rio existente
                    const { error } = await supabase
                        .from('usuarios')
                        .update({
                            nome,
                            email,
                            setor: setor,
                            tipo_usuario: tipo,
                            ativo
                        })
                        .eq('id', id);

                    if (error) throw error;

                    mostrarAlerta('Usu√°rio atualizado com sucesso!', 'success');
                } else {
                    // Criar novo usu√°rio
                    const resultado = await criarUsuario({
                        nome: nome,
                        email: email,
                        setor: setor,
                        tipo_usuario: tipo
                    });
                    
                    if (resultado.sucesso) {
                        // Fechar modal de cria√ß√£o
                        fecharModalUsuario();
                        
                        // Recarregar lista de usu√°rios
                        await carregarUsuarios();
                        
                        // Abrir modal com senha tempor√°ria
                        abrirModalSenhaTemporaria(resultado.senhaTemporaria);
                        
                        // N√£o executa o c√≥digo ap√≥s o try/catch para cria√ß√£o
                        return;
                    } else {
                        throw new Error(resultado.erro);
                    }
                }

                fecharModalUsuario();
                await carregarUsuarios();
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                mostrarAlerta('Erro ao salvar usu√°rio: ' + error.message, 'error');
            }
        }

        // Toggle ativo/inativo
        async function toggleAtivo(id, novoStatus) {
            if (!confirm(`Deseja realmente ${novoStatus ? 'ativar' : 'desativar'} este usu√°rio?`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('usuarios')
                    .update({ ativo: novoStatus })
                    .eq('id', id);

                if (error) throw error;

                mostrarAlerta('Status atualizado com sucesso!', 'success');
                await carregarUsuarios();
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                mostrarAlerta('Erro ao atualizar status', 'error');
            }
        }

        // Abrir modal reset senha
        function abrirModalReset(id) {
            usuarioResetId = id;
            document.getElementById('senhaGeradaContainer').style.display = 'none';
            document.getElementById('senhaGerada').value = '';
            document.getElementById('btnResetarSenha').style.display = 'block';
            document.getElementById('modalResetSenha').style.display = 'flex';
        }

        // Fechar modal reset
        function fecharModalReset() {
            document.getElementById('modalResetSenha').style.display = 'none';
            usuarioResetId = null;
        }

        // Abrir modal senha tempor√°ria
        function abrirModalSenhaTemporaria(senha) {
            document.getElementById('senhaTemporariaGerada').value = senha;
            document.getElementById('modalSenhaTemporaria').style.display = 'flex';
        }

        // Fechar modal senha tempor√°ria
        function fecharModalSenhaTemporaria() {
            document.getElementById('modalSenhaTemporaria').style.display = 'none';
            document.getElementById('senhaTemporariaGerada').value = '';
        }

        // Copiar senha tempor√°ria
        function copiarSenhaTemporaria() {
            const senhaInput = document.getElementById('senhaTemporariaGerada');
            senhaInput.select();
            senhaInput.setSelectionRange(0, 99999); // Para dispositivos m√≥veis
            
            navigator.clipboard.writeText(senhaInput.value).then(() => {
                mostrarAlerta('Senha copiada para a √°rea de transfer√™ncia!', 'success');
            }).catch(err => {
                console.error('Erro ao copiar senha:', err);
                mostrarAlerta('Erro ao copiar senha. Copie manualmente.', 'error');
            });
        }

        // Confirmar reset de senha
        async function confirmarReset() {
            if (!usuarioResetId) return;

            try {
                const novaSenha = await resetarSenha(usuarioResetId);
                
                document.getElementById('senhaGerada').value = novaSenha;
                document.getElementById('senhaGeradaContainer').style.display = 'block';
                document.getElementById('btnResetarSenha').style.display = 'none';
                
                mostrarAlerta('Senha resetada com sucesso!', 'success');
                await carregarUsuarios();
            } catch (error) {
                console.error('Erro ao resetar senha:', error);
                mostrarAlerta('Erro ao resetar senha', 'error');
            }
        }

        // Copiar senha
        function copiarSenha() {
            const input = document.getElementById('senhaGerada');
            input.select();
            document.execCommand('copy');
            mostrarAlerta('Senha copiada para a √°rea de transfer√™ncia!', 'success');
        }

        // Mostrar alerta
        function mostrarAlerta(mensagem, tipo = 'info') {
            // Criar elemento de alerta
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo === 'error' ? 'danger' : tipo === 'success' ? 'success' : 'info'}`;
            alerta.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; animation: slideIn 0.3s;';
            alerta.innerHTML = `
                <strong>${tipo === 'error' ? '‚ùå' : tipo === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</strong>
                ${mensagem}
            `;
            
            document.body.appendChild(alerta);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                alerta.style.animation = 'slideOut 0.3s';
                setTimeout(() => alerta.remove(), 300);
            }, 5000);
        }
    </script>
</body>
</html>
